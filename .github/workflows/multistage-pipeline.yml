name: Simple Multistage Pipeline

on:
  push:
    branches:
      - main

jobs:
  # BUILD STAGE - RUNS FIRST
  build:
    name: Build Application
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: |
          echo "üî® Building application..."
          echo "Timestamp: $(date)"
          echo "Files compiled successfully"

  # DEVELOPMENT STAGE - DEPENDS ON BUILD
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Checkout other repo (for scripts)
        uses: actions/checkout@v4
        with:
          repository: Deepa-h-o/other-repo
          path: other-repo
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Run script from other repo
        run: |
          chmod +x other-repo/scripts/hello.sh || true
          bash other-repo/scripts/hello.sh dev-arg

  # STAGING STAGE - DEPENDS ON DEV
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: deploy-dev
    steps:
      - uses: actions/checkout@v4
      - name: Checkout other repo (for scripts)
        uses: actions/checkout@v4
        with:
          repository: Deepa-h-o/other-repo
          path: other-repo
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Run Tests
        run: |
          echo "üß™ Running tests on staging..."
          echo "Dev Status: SUCCESS ‚úì"
          echo "Checking file integrity..."
      - name: Run script from other repo
        run: |
          chmod +x other-repo/scripts/hello.sh || true
          bash other-repo/scripts/hello.sh staging-arg
      - name: Deploy to Staging
        run: |
          echo "‚úÖ Deploying to Staging..."
          echo "Timestamp: $(date)"

  # PRODUCTION STAGE - DEPENDS ON STAGING
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4
      - name: Checkout other repo (for scripts)
        uses: actions/checkout@v4
        with:
          repository: Deepa-h-o/other-repo
          path: other-repo
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Pre-deploy Checks
        run: |
          echo "üîç Running pre-deployment checks..."
          echo "Staging Status: SUCCESS ‚úì"
          echo "Verifying all files..."
      - name: Run script from other repo
        run: |
          chmod +x other-repo/scripts/hello.sh || true
          bash other-repo/scripts/hello.sh prod-arg
      - name: Deploy to Production
        run: |
          echo "‚úÖ Deploying to Production..."
          echo "Timestamp: $(date)"
          echo "‚ö†Ô∏è LIVE PRODUCTION DEPLOYMENT - All tests passed!"
